<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../jacoco-resources/report.gif" type="image/gif"/><title>InstallMojo.java</title><link rel="stylesheet" href="../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">itf-maven-plugin</a> &gt; <a href="index.source.html" class="el_package">com.soebes.itf.maven.plugin</a> &gt; <span class="el_source">InstallMojo.java</span></div><h1>InstallMojo.java</h1><pre class="source lang-java linenums">package com.soebes.itf.maven.plugin;

/*
 * Licensed to the Apache Software Foundation (ASF) under one
 * or more contributor license agreements.  See the NOTICE file
 * distributed with this work for additional information
 * regarding copyright ownership.  The ASF licenses this file
 * to you under the Apache License, Version 2.0 (the
 * &quot;License&quot;); you may not use this file except in compliance
 * with the License.  You may obtain a copy of the License at
 *
 *  http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing,
 * software distributed under the License is distributed on an
 * &quot;AS IS&quot; BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY
 * KIND, either express or implied.  See the License for the
 * specific language governing permissions and limitations
 * under the License.
 */

import org.apache.maven.artifact.Artifact;
import org.apache.maven.artifact.factory.ArtifactFactory;
import org.apache.maven.artifact.repository.ArtifactRepository;
import org.apache.maven.execution.MavenSession;
import org.apache.maven.model.Model;
import org.apache.maven.model.Parent;
import org.apache.maven.plugin.AbstractMojo;
import org.apache.maven.plugin.MojoExecutionException;
import org.apache.maven.plugin.MojoFailureException;
import org.apache.maven.plugins.annotations.Component;
import org.apache.maven.plugins.annotations.LifecyclePhase;
import org.apache.maven.plugins.annotations.Mojo;
import org.apache.maven.plugins.annotations.Parameter;
import org.apache.maven.plugins.annotations.ResolutionScope;
import org.apache.maven.project.MavenProject;
import org.apache.maven.project.ProjectBuildingRequest;
import org.apache.maven.shared.transfer.artifact.install.ArtifactInstaller;
import org.apache.maven.shared.transfer.repository.RepositoryManager;
import org.codehaus.plexus.util.FileUtils;

import java.io.File;
import java.io.IOException;
import java.util.Collection;
import java.util.Collections;
import java.util.HashMap;
import java.util.HashSet;
import java.util.LinkedHashSet;
import java.util.Map;

/**
 * itf-maven-plugin.
 *
 * @author @author &lt;a href=&quot;mailto:khmarbaise@apache.org&quot;&gt;Karl Heinz Marbaise&lt;/a&gt;
 * @implNote Several parts are taken from the maven-invoker-plugin.
 */
@Mojo(name = &quot;install&quot;, defaultPhase = LifecyclePhase.PRE_INTEGRATION_TEST,
		requiresDependencyResolution = ResolutionScope.RUNTIME, threadSafe = true)
<span class="nc" id="L59">public class InstallMojo extends AbstractMojo {</span>
	@Parameter(defaultValue = &quot;${session}&quot;, required = true, readonly = true)
	private MavenSession session;

	@Parameter(defaultValue = &quot;${project}&quot;, required = true, readonly = true)
	private MavenProject project;

	@Parameter(defaultValue = &quot;${project.basedir}/target/invoker-repo&quot;, required = true)
	private File invokerRepository;

	@Component
	private RepositoryManager repositoryManager;

	@Component
	private ArtifactInstaller installer;

	/**
	 * The set of Maven projects in the reactor build.
	 */
	@Parameter(defaultValue = &quot;${reactorProjects}&quot;, readonly = true)
	private Collection&lt;MavenProject&gt; reactorProjects;

	/**
	 * The identifiers of already installed artifacts, used to avoid multiple installation of the same artifact.
	 */
	private Collection&lt;String&gt; installedArtifacts;

	/**
	 * The identifiers of already copied artifacts, used to avoid multiple installation of the same artifact.
	 */
	private Collection&lt;String&gt; copiedArtifacts;

	/**
	 * The component used to create artifacts.
	 */
	@Component
	private ArtifactFactory artifactFactory;

	/**
	 *
	 */
	@Parameter(property = &quot;localRepository&quot;, required = true, readonly = true)
	private ArtifactRepository localRepository;

	private ProjectBuildingRequest projectBuildingRequest;

	public void execute() throws MojoExecutionException, MojoFailureException {
<span class="nc" id="L106">		createTestRepository();</span>

<span class="nc" id="L108">		installedArtifacts = new HashSet&lt;&gt;();</span>
<span class="nc" id="L109">		copiedArtifacts = new HashSet&lt;&gt;();</span>

<span class="nc" id="L111">		installProjectDependencies(project, reactorProjects);</span>
<span class="nc" id="L112">		installProjectParents(project);</span>
<span class="nc" id="L113">		installProjectArtifacts(project);</span>

		//TODO: We should consider to implement this?
//        installExtraArtifacts( extraArtifacts );

<span class="nc" id="L118">	}</span>


	private void createTestRepository()
			throws MojoExecutionException {

<span class="nc bnc" id="L124" title="All 4 branches missed.">		if (!invokerRepository.exists() &amp;&amp; !invokerRepository.mkdirs()) {</span>
<span class="nc" id="L125">			throw new MojoExecutionException(&quot;Failed to create directory: &quot; + invokerRepository);</span>
		}
<span class="nc" id="L127">		projectBuildingRequest =</span>
<span class="nc" id="L128">				repositoryManager.setLocalRepositoryBasedir(session.getProjectBuildingRequest(), invokerRepository);</span>
<span class="nc" id="L129">	}</span>

	/**
	 * Installs the specified artifact to the local repository. Note: This method should only be used for artifacts that
	 * originate from the current (reactor) build. Artifacts that have been grabbed from the user's local repository
	 * should be installed to the test repository via {@link #copyArtifact(File, Artifact)}.
	 *
	 * @param file     The file associated with the artifact, must not be &lt;code&gt;null&lt;/code&gt;. This is in most cases the value
	 *                 of &lt;code&gt;artifact.getFile()&lt;/code&gt; with the exception of the main artifact from a project with
	 *                 packaging &quot;pom&quot;. Projects with packaging &quot;pom&quot; have no main artifact file. They have however artifact
	 *                 metadata (e.g. site descriptors) which needs to be installed.
	 * @param artifact The artifact to install, must not be &lt;code&gt;null&lt;/code&gt;.
	 * @throws MojoExecutionException If the artifact could not be installed (e.g. has no associated file).
	 */
	private void installArtifact(File file, Artifact artifact)
			throws MojoExecutionException {
		try {
<span class="nc bnc" id="L146" title="All 2 branches missed.">			if (file == null) {</span>
<span class="nc" id="L147">				throw new IllegalStateException(&quot;Artifact has no associated file: &quot; + artifact.getId());</span>
			}
<span class="nc bnc" id="L149" title="All 2 branches missed.">			if (!file.isFile()) {</span>
<span class="nc" id="L150">				throw new IllegalStateException(&quot;Artifact is not fully assembled: &quot; + file);</span>
			}

<span class="nc bnc" id="L153" title="All 2 branches missed.">			if (installedArtifacts.add(artifact.getId())) {</span>
<span class="nc" id="L154">				artifact.setFile(file);</span>
<span class="nc" id="L155">				installer.install(projectBuildingRequest, invokerRepository,</span>
<span class="nc" id="L156">						Collections.singletonList(artifact));</span>
			} else {
<span class="nc" id="L158">				getLog().debug(&quot;Not re-installing &quot; + artifact + &quot;, &quot; + file);</span>
			}
<span class="nc" id="L160">		} catch (Exception e) {</span>
<span class="nc" id="L161">			throw new MojoExecutionException(&quot;Failed to install artifact: &quot; + artifact, e);</span>
<span class="nc" id="L162">		}</span>
<span class="nc" id="L163">	}</span>

	/**
	 * Installs the specified artifact to the local repository. This method serves basically the same purpose as
	 * {@link #installArtifact(File, Artifact)} but is meant for artifacts that have been resolved
	 * from the user's local repository (and not the current build outputs). The subtle difference here is that
	 * artifacts from the repository have already undergone transformations and these manipulations should not be redone
	 * by the artifact installer. For this reason, this method performs plain copy operations to install the artifacts.
	 *
	 * @param file     The file associated with the artifact, must not be &lt;code&gt;null&lt;/code&gt;.
	 * @param artifact The artifact to install, must not be &lt;code&gt;null&lt;/code&gt;.
	 * @throws MojoExecutionException If the artifact could not be installed (e.g. has no associated file).
	 */
	private void copyArtifact(File file, Artifact artifact)
			throws MojoExecutionException {
		try {
<span class="nc bnc" id="L179" title="All 2 branches missed.">			if (file == null) {</span>
<span class="nc" id="L180">				throw new IllegalStateException(&quot;Artifact has no associated file: &quot; + artifact.getId());</span>
			}
<span class="nc bnc" id="L182" title="All 2 branches missed.">			if (!file.isFile()) {</span>
<span class="nc" id="L183">				throw new IllegalStateException(&quot;Artifact is not fully assembled: &quot; + file);</span>
			}

<span class="nc bnc" id="L186" title="All 2 branches missed.">			if (copiedArtifacts.add(artifact.getId())) {</span>
<span class="nc" id="L187">				File destination =</span>
						new File(invokerRepository,
<span class="nc" id="L189">								repositoryManager.getPathForLocalArtifact(projectBuildingRequest, artifact));</span>

<span class="nc" id="L191">				getLog().debug(&quot;Installing &quot; + file + &quot; to &quot; + destination);</span>

<span class="nc" id="L193">				copyFileIfDifferent(file, destination);</span>

<span class="nc" id="L195">				MetadataUtils.createMetadata( destination, artifact );</span>
<span class="nc" id="L196">			} else {</span>
<span class="nc" id="L197">				getLog().debug(&quot;Not re-installing &quot; + artifact + &quot;, &quot; + file);</span>
			}
<span class="nc" id="L199">		} catch (Exception e) {</span>
<span class="nc" id="L200">			throw new MojoExecutionException(&quot;Failed to stage artifact: &quot; + artifact, e);</span>
<span class="nc" id="L201">		}</span>
<span class="nc" id="L202">	}</span>

	private void copyFileIfDifferent(File src, File dst)
			throws IOException {
<span class="nc bnc" id="L206" title="All 4 branches missed.">		if (src.lastModified() != dst.lastModified() || src.length() != dst.length()) {</span>
<span class="nc" id="L207">			FileUtils.copyFile(src, dst);</span>
<span class="nc" id="L208">			dst.setLastModified(src.lastModified());</span>
		}
<span class="nc" id="L210">	}</span>

	/**
	 * Installs the main artifact and any attached artifacts of the specified project to the local repository.
	 *
	 * @param mvnProject The project whose artifacts should be installed, must not be &lt;code&gt;null&lt;/code&gt;.
	 * @throws MojoExecutionException If any artifact could not be installed.
	 */
	private void installProjectArtifacts(MavenProject mvnProject)
			throws MojoExecutionException {
		try {
			// Install POM (usually attached as metadata but that happens only as a side effect of the Install Plugin)
<span class="nc" id="L222">			installProjectPom(mvnProject);</span>

			// Install the main project artifact (if the project has one, e.g. has no &quot;pom&quot; packaging)
<span class="nc" id="L225">			Artifact mainArtifact = mvnProject.getArtifact();</span>
<span class="nc bnc" id="L226" title="All 2 branches missed.">			if (mainArtifact.getFile() != null) {</span>
<span class="nc" id="L227">				installArtifact(mainArtifact.getFile(), mainArtifact);</span>
			}

			// Install any attached project artifacts
<span class="nc" id="L231">			Collection&lt;Artifact&gt; attachedArtifacts = mvnProject.getAttachedArtifacts();</span>
<span class="nc bnc" id="L232" title="All 2 branches missed.">			for (Artifact attachedArtifact : attachedArtifacts) {</span>
<span class="nc" id="L233">				installArtifact(attachedArtifact.getFile(), attachedArtifact);</span>
<span class="nc" id="L234">			}</span>
<span class="nc" id="L235">		} catch (Exception e) {</span>
<span class="nc" id="L236">			throw new MojoExecutionException(&quot;Failed to install project artifacts: &quot; + mvnProject, e);</span>
<span class="nc" id="L237">		}</span>
<span class="nc" id="L238">	}</span>

	/**
	 * Installs the (locally reachable) parent POMs of the specified project to the local repository. The parent POMs
	 * from the reactor must be installed or the forked IT builds will fail when using a clean repository.
	 *
	 * @param mvnProject The project whose parent POMs should be installed, must not be &lt;code&gt;null&lt;/code&gt;.
	 * @throws MojoExecutionException If any POM could not be installed.
	 */
	private void installProjectParents(MavenProject mvnProject)
			throws MojoExecutionException {
		try {
<span class="nc bnc" id="L250" title="All 2 branches missed.">			for (MavenProject parent = mvnProject.getParent(); parent != null; parent = parent.getParent()) {</span>
<span class="nc bnc" id="L251" title="All 2 branches missed.">				if (parent.getFile() == null) {</span>
<span class="nc" id="L252">					copyParentPoms(parent.getGroupId(), parent.getArtifactId(), parent.getVersion());</span>
<span class="nc" id="L253">					break;</span>
				}
<span class="nc" id="L255">				installProjectPom(parent);</span>
			}
<span class="nc" id="L257">		} catch (Exception e) {</span>
<span class="nc" id="L258">			throw new MojoExecutionException(&quot;Failed to install project parents: &quot; + mvnProject, e);</span>
<span class="nc" id="L259">		}</span>
<span class="nc" id="L260">	}</span>

	/**
	 * Installs the POM of the specified project to the local repository.
	 *
	 * @param mvnProject The project whose POM should be installed, must not be &lt;code&gt;null&lt;/code&gt;.
	 * @throws MojoExecutionException If the POM could not be installed.
	 */
	private void installProjectPom(MavenProject mvnProject)
			throws MojoExecutionException {
		try {
<span class="nc" id="L271">			Artifact pomArtifact = null;</span>
<span class="nc bnc" id="L272" title="All 2 branches missed.">			if (&quot;pom&quot;.equals(mvnProject.getPackaging())) {</span>
<span class="nc" id="L273">				pomArtifact = mvnProject.getArtifact();</span>
			}
<span class="nc bnc" id="L275" title="All 2 branches missed.">			if (pomArtifact == null) {</span>
<span class="nc" id="L276">				pomArtifact =</span>
<span class="nc" id="L277">						artifactFactory.createProjectArtifact(mvnProject.getGroupId(), mvnProject.getArtifactId(),</span>
<span class="nc" id="L278">								mvnProject.getVersion());</span>
			}
<span class="nc" id="L280">			installArtifact(mvnProject.getFile(), pomArtifact);</span>
<span class="nc" id="L281">		} catch (Exception e) {</span>
<span class="nc" id="L282">			throw new MojoExecutionException(&quot;Failed to install POM: &quot; + mvnProject, e);</span>
<span class="nc" id="L283">		}</span>
<span class="nc" id="L284">	}</span>

	/**
	 * Installs the dependent projects from the reactor to the local repository. The dependencies on other modules from
	 * the reactor must be installed or the forked IT builds will fail when using a clean repository.
	 *
	 * @param mvnProject      The project whose dependent projects should be installed, must not be &lt;code&gt;null&lt;/code&gt;.
	 * @param reactorProjects The set of projects in the reactor build, must not be &lt;code&gt;null&lt;/code&gt;.
	 * @throws MojoExecutionException If any dependency could not be installed.
	 */
	private void installProjectDependencies(MavenProject mvnProject, Collection&lt;MavenProject&gt; reactorProjects)
			throws MojoExecutionException {
		// ... into dependencies that were resolved from reactor projects ...
<span class="nc" id="L297">		Collection&lt;String&gt; dependencyProjects = new LinkedHashSet&lt;&gt;();</span>
<span class="nc" id="L298">		collectAllProjectReferences(mvnProject, dependencyProjects);</span>

		// index available reactor projects
<span class="nc" id="L301">		Map&lt;String, MavenProject&gt; projects = new HashMap&lt;&gt;(reactorProjects.size());</span>
<span class="nc bnc" id="L302" title="All 2 branches missed.">		for (MavenProject reactorProject : reactorProjects) {</span>
<span class="nc" id="L303">			String projectId =</span>
<span class="nc" id="L304">					reactorProject.getGroupId() + ':' + reactorProject.getArtifactId() + ':' + reactorProject.getVersion();</span>

<span class="nc" id="L306">			projects.put(projectId, reactorProject);</span>
<span class="nc" id="L307">		}</span>

		// group transitive dependencies (even those that don't contribute to the class path like POMs) ...
<span class="nc" id="L310">		Collection&lt;Artifact&gt; artifacts = mvnProject.getArtifacts();</span>
		// ... and those that were resolved from the (local) repo
<span class="nc" id="L312">		Collection&lt;Artifact&gt; dependencyArtifacts = new LinkedHashSet&lt;&gt;();</span>

<span class="nc bnc" id="L314" title="All 2 branches missed.">		for (Artifact artifact : artifacts) {</span>
			// workaround for MNG-2961 to ensure the base version does not contain a timestamp
<span class="nc" id="L316">			artifact.isSnapshot();</span>

<span class="nc" id="L318">			String projectId = artifact.getGroupId() + ':' + artifact.getArtifactId() + ':' + artifact.getBaseVersion();</span>

<span class="nc bnc" id="L320" title="All 2 branches missed.">			if (!projects.containsKey(projectId)) {</span>
<span class="nc" id="L321">				dependencyArtifacts.add(artifact);</span>
			}
<span class="nc" id="L323">		}</span>

		// install dependencies
		try {
			// copy dependencies that where resolved from the local repo
<span class="nc bnc" id="L328" title="All 2 branches missed.">			for (Artifact artifact : dependencyArtifacts) {</span>
<span class="nc" id="L329">				copyArtifact(artifact);</span>
<span class="nc" id="L330">			}</span>

			// install dependencies that were resolved from the reactor
<span class="nc bnc" id="L333" title="All 2 branches missed.">			for (String projectId : dependencyProjects) {</span>
<span class="nc" id="L334">				MavenProject dependencyProject = projects.get(projectId);</span>
<span class="nc bnc" id="L335" title="All 2 branches missed.">				if (dependencyProject == null) {</span>
<span class="nc" id="L336">					getLog().warn(&quot;skip dependencyProject null for projectId=&quot; + projectId);</span>
<span class="nc" id="L337">					continue;</span>
				}
<span class="nc" id="L339">				getLog().info(&quot; *-&gt; &quot; + project.getId());</span>
<span class="nc" id="L340">				installProjectArtifacts(dependencyProject);</span>
<span class="nc" id="L341">				installProjectParents(dependencyProject);</span>
<span class="nc" id="L342">			}</span>
<span class="nc" id="L343">		} catch (Exception e) {</span>
<span class="nc" id="L344">			throw new MojoExecutionException(&quot;Failed to install project dependencies: &quot; + mvnProject, e);</span>
<span class="nc" id="L345">		}</span>
<span class="nc" id="L346">	}</span>

	protected void collectAllProjectReferences(MavenProject project, Collection&lt;String&gt; dependencyProjects) {
<span class="nc bnc" id="L349" title="All 2 branches missed.">		for (MavenProject reactorProject : project.getProjectReferences().values()) {</span>
<span class="nc" id="L350">			String projectId =</span>
<span class="nc" id="L351">					reactorProject.getGroupId() + ':' + reactorProject.getArtifactId() + ':' + reactorProject.getVersion();</span>
<span class="nc bnc" id="L352" title="All 2 branches missed.">			if (dependencyProjects.add(projectId)) {</span>
<span class="nc" id="L353">				collectAllProjectReferences(reactorProject, dependencyProjects);</span>
			}
<span class="nc" id="L355">		}</span>
<span class="nc" id="L356">	}</span>

	private void copyArtifact(Artifact artifact)
			throws MojoExecutionException {
<span class="nc" id="L360">		copyPoms(artifact);</span>

<span class="nc" id="L362">		Artifact depArtifact =</span>
<span class="nc" id="L363">				artifactFactory.createArtifactWithClassifier(artifact.getGroupId(), artifact.getArtifactId(),</span>
<span class="nc" id="L364">						artifact.getBaseVersion(), artifact.getType(),</span>
<span class="nc" id="L365">						artifact.getClassifier());</span>

<span class="nc" id="L367">		File artifactFile = artifact.getFile();</span>

<span class="nc" id="L369">		copyArtifact(artifactFile, depArtifact);</span>
<span class="nc" id="L370">	}</span>

	private void copyPoms(Artifact artifact)
			throws MojoExecutionException {
<span class="nc" id="L374">		Artifact pomArtifact =</span>
<span class="nc" id="L375">				artifactFactory.createProjectArtifact(artifact.getGroupId(), artifact.getArtifactId(),</span>
<span class="nc" id="L376">						artifact.getBaseVersion());</span>

<span class="nc" id="L378">		File pomFile = new File(localRepository.getBasedir(), localRepository.pathOf(pomArtifact));</span>

<span class="nc bnc" id="L380" title="All 2 branches missed.">		if (pomFile.isFile()) {</span>
<span class="nc" id="L381">			copyArtifact(pomFile, pomArtifact);</span>
<span class="nc" id="L382">			copyParentPoms(pomFile);</span>
		}
<span class="nc" id="L384">	}</span>

	/**
	 * Installs all parent POMs of the specified POM file that are available in the local repository.
	 *
	 * @param pomFile The path to the POM file whose parents should be installed, must not be &lt;code&gt;null&lt;/code&gt;.
	 * @throws MojoExecutionException If any (existing) parent POM could not be installed.
	 */
	private void copyParentPoms(File pomFile)
			throws MojoExecutionException {
<span class="nc" id="L394">		Model model = PomUtils.loadPom(pomFile);</span>
<span class="nc" id="L395">		Parent parent = model.getParent();</span>
<span class="nc bnc" id="L396" title="All 2 branches missed.">		if (parent != null) {</span>
<span class="nc" id="L397">			copyParentPoms(parent.getGroupId(), parent.getArtifactId(), parent.getVersion());</span>
		}
<span class="nc" id="L399">	}</span>

	/**
	 * Installs the specified POM and all its parent POMs to the local repository.
	 *
	 * @param groupId    The group id of the POM which should be installed, must not be &lt;code&gt;null&lt;/code&gt;.
	 * @param artifactId The artifact id of the POM which should be installed, must not be &lt;code&gt;null&lt;/code&gt;.
	 * @param version    The version of the POM which should be installed, must not be &lt;code&gt;null&lt;/code&gt;.
	 * @throws MojoExecutionException If any (existing) parent POM could not be installed.
	 */
	private void copyParentPoms(String groupId, String artifactId, String version)
			throws MojoExecutionException {
<span class="nc" id="L411">		Artifact pomArtifact = artifactFactory.createProjectArtifact(groupId, artifactId, version);</span>

<span class="nc bnc" id="L413" title="All 4 branches missed.">		if (installedArtifacts.contains(pomArtifact.getId()) || copiedArtifacts.contains(pomArtifact.getId())) {</span>
<span class="nc" id="L414">			getLog().debug(&quot;Not re-installing &quot; + pomArtifact);</span>
<span class="nc" id="L415">			return;</span>
		}

<span class="nc" id="L418">		File pomFile = new File(localRepository.getBasedir(), localRepository.pathOf(pomArtifact));</span>
<span class="nc bnc" id="L419" title="All 2 branches missed.">		if (pomFile.isFile()) {</span>
<span class="nc" id="L420">			copyArtifact(pomFile, pomArtifact);</span>
<span class="nc" id="L421">			copyParentPoms(pomFile);</span>
		}
<span class="nc" id="L423">	}</span>


}
</pre><div class="footer"><span class="right">Created with <a href="http://www.jacoco.org/jacoco">JaCoCo</a> 0.8.5.201910111838</span></div></body></html>